
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>The Thread Class &#8212; vAmiga 2.4</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/insipid.css" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script defer src="../_static/insipid.js"></script>
    <script defer src="../_static/insipid-sidebar.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The Message Queue" href="MessageQueue.html" />
    <link rel="prev" title="The Class Hierarchy" href="ClassHierarchy.html" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
  </head><body>
    <script type="text/javascript">
        document.body.classList.add('js');
    </script>
    <input type="checkbox" id="sidebar-checkbox" style="display: none;">
    <label id="overlay" for="sidebar-checkbox"></label>
    <div class="sidebar-resize-handle"></div>
    <script type="text/javascript">
        try {
            let sidebar = localStorage.getItem('sphinx-sidebar');
            const sidebar_width = localStorage.getItem('sphinx-sidebar-width');
            if (sidebar_width) {
                document.documentElement.style.setProperty('--sidebar-width', sidebar_width);
            }
            // show sidebar on wide screen
            if (!sidebar && window.matchMedia('(min-width: 0)').matches) {
                sidebar = 'visible';
                // NB: We don't store the value in localStorage!
            }
            if (sidebar === 'visible') {
                document.getElementById('sidebar-checkbox').checked = true;
            }
        } catch(e) {
            console.info(e);
        }
    </script>
    <header id="topbar-placeholder">
      <div id="topbar">
        <div id="titlebar">
          <div class="buttons">
            <label for="sidebar-checkbox" id="sidebar-button" role="button" tabindex="0" aria-controls="sphinxsidebar" accesskey="M">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg>
            </label>
            <button id="search-button" type="button" title="Search" aria-label="Search" aria-expanded="false" aria-controls="search-form" accesskey="S">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
            </button>
          </div>
          <div class="title">
            <a class="parent" href="../index.html" accesskey="U">vAmiga 2.4</a>
            <a class="top" href="#">The Thread Class</a>
          </div>
          <div class="buttons">
            <button id="fullscreen-button" type="button" aria-hidden="true">
              <span class="enable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M212.686 315.314L120 408l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C10.697 480 0 469.255 0 456V344c0-21.382 25.803-32.09 40.922-16.971L72 360l92.686-92.686c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.249 6.248 6.249 16.378 0 22.627zm22.628-118.628L328 104l-32.922-31.029C279.958 57.851 290.666 32 312.048 32h112C437.303 32 448 42.745 448 56v112c0 21.382-25.803 32.09-40.922 16.971L376 152l-92.686 92.686c-6.248 6.248-16.379 6.248-22.627 0l-25.373-25.373c-6.249-6.248-6.249-16.378 0-22.627z"/></svg>
              </span>
              <span class="disable">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M4.686 427.314L104 328l-32.922-31.029C55.958 281.851 66.666 256 88.048 256h112C213.303 256 224 266.745 224 280v112c0 21.382-25.803 32.09-40.922 16.971L152 376l-99.314 99.314c-6.248 6.248-16.379 6.248-22.627 0L4.686 449.941c-6.248-6.248-6.248-16.379 0-22.627zM443.314 84.686L344 184l32.922 31.029c15.12 15.12 4.412 40.971-16.97 40.971h-112C234.697 256 224 245.255 224 232V120c0-21.382 25.803-32.09 40.922-16.971L296 136l99.314-99.314c6.248-6.248 16.379-6.248 22.627 0l25.373 25.373c6.248 6.248 6.248 16.379 0 22.627z"/></svg>
              </span>
            </button>
          </div>
        </div>
        <div id="searchbox" role="search">
          <form id="search-form" class="search" style="display: none" action="../search.html" method="get">
            <input type="search" name="q" placeholder="Search ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <button>Go</button>
          </form>
        </div>
      </div>
    </header>
    <nav>
      <a href="ClassHierarchy.html" class="nav-icon previous" title="previous:&#13;The Class Hierarchy" aria-label="Previous topic" accesskey="P" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6 0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>
      </a>
      <a href="MessageQueue.html" class="nav-icon next" title="next:&#13;The Message Queue" aria-label="Next topic" accesskey="N" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg>
      </a>
    </nav>

    <nav class="relbar">
      <a class="previous" href="ClassHierarchy.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            The Class Hierarchy
          </span>
        </div>
      </a>
      <a class="next" href="MessageQueue.html" aria-label="Next topic" >
        <div class="title">
          <span class="text">
            <span class="direction">next</span>
            The Message Queue
          </span>
        </div>
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/></svg>
        </div>
      </a>
    </nav>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<section id="the-thread-class">
<h1>The Thread Class<a class="headerlink" href="#the-thread-class" title="Permalink to this heading">Â¶</a></h1>
<p>In this document we will take a closer look at the <code class="docutils literal notranslate"><span class="pre">Thread</span></code> class, which adds concurrent code execution capabilities to the <code class="docutils literal notranslate"><span class="pre">Amiga</span></code> class. In addition, it implements the state model of the emulator.</p>
<p><img alt="Thread class" src="../_images/classHierarchyThread.png" /></p>
<p>Creating an emulator instance comprises two steps:</p>
<ul class="simple">
<li><p>Creating an instance of the <code class="docutils literal notranslate"><span class="pre">Amiga</span></code> class.</p></li>
<li><p>Calling <code class="docutils literal notranslate"><span class="pre">Amiga::launch()</span></code>.</p></li>
</ul>
<p>Inside <code class="docutils literal notranslate"><span class="pre">Amiga::launch()</span></code>, an emulator thread is spawned in the constructor:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Amiga</span><span class="o">::</span><span class="n">launch</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="kr">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Thread</span><span class="o">::</span><span class="n">main</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The thread is never terminated. It remains alive until the application quits.</p>
<section id="main-function">
<h2>Main function<a class="headerlink" href="#main-function" title="Permalink to this heading">Â¶</a></h2>
<p>After the thread has been created, it starts executing the <code class="docutils literal notranslate"><span class="pre">Thread::main</span></code> function which is inherited from the <code class="docutils literal notranslate"><span class="pre">Thread</span></code> class. This function consists of a large <code class="docutils literal notranslate"><span class="pre">while</span></code> loop which looks like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Thread::main</span><span class="p">()</span>
<span class="p">{</span><span class="w">    </span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">loopCounter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isRunning</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getThreadMode</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">THREAD_PERIODIC</span><span class="p">:</span><span class="w">   </span><span class="n">execute</span><span class="o">&lt;</span><span class="n">THREAD_PERIODIC</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">THREAD_PULSED</span><span class="p">:</span><span class="w">     </span><span class="n">execute</span><span class="o">&lt;</span><span class="n">THREAD_PULSED</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">THREAD_ADAPTIVE</span><span class="p">:</span><span class="w">   </span><span class="n">execute</span><span class="o">&lt;</span><span class="n">THREAD_ADAPTIVE</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">                </span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">warpMode</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">isRunning</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">getThreadMode</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>

<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">THREAD_PERIODIC</span><span class="p">:</span><span class="w">   </span><span class="n">sleep</span><span class="o">&lt;</span><span class="n">THREAD_PERIODIC</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">THREAD_PULSED</span><span class="p">:</span><span class="w">     </span><span class="n">sleep</span><span class="o">&lt;</span><span class="n">THREAD_PULSED</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="no">THREAD_ADAPTIVE</span><span class="p">:</span><span class="w">   </span><span class="n">sleep</span><span class="o">&lt;</span><span class="n">THREAD_ADAPTIVE</span><span class="o">&gt;</span><span class="p">();</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stateChangeRequest</span><span class="p">.</span><span class="n">test</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="n">switchState</span><span class="p">(</span><span class="n">newState</span><span class="p">);</span>
<span class="w">            </span><span class="n">stateChangeRequest</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">            </span><span class="n">stateChangeRequest</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXEC_HALTED</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="p">...</span><span class="w">       </span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Because the thread is never terminated, the loop is executed during the entire lifetime of the application. Within the loop body, two switch-case blocks can be spotted. The first one is executed as long as the emulator is running and calls one of three possible functions, depending on the operation mode of the thread. Both functions emulate the Amiga for a single frame. The second switch-case block is executed when the emulator is not running in warp mode. Within this block, one of three synchronization functions is called, again depending on the selected operation mode. The purpose of these functions is to keep the thread running at the right pace. That is, they ensure that the functions are called 50 times per second for PAL machines and 60 times per second for NTSC machines.</p>
<p>Three synchronization modes are available: <em>Periodic</em>, <em>Pulsed</em>, and <em>Adaptive</em>.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">enum_long</span><span class="p">(</span><span class="n">THREAD_MODE</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">THREAD_PERIODIC</span><span class="p">,</span>
<span class="w">    </span><span class="n">THREAD_PULSED</span><span class="p">,</span>
<span class="w">    </span><span class="n">THREAD_ADAPTIVE</span>
<span class="p">};</span>
<span class="k">typedef</span><span class="w"> </span><span class="n">THREAD_MODE</span><span class="w"> </span><span class="n">ThreadMode</span><span class="p">;</span>
</pre></div>
</div>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">THREAD_PERIODIC</span></code>:</p>
<p>In periodic mode the thread puts itself to sleep and utilizes a timer to schedule a wakeup call. In this mode, no further action has to be taken by the GUI. This method had been the default mode used by vAmiga up to version 2.3.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">THREAD_PULSED</span></code></p>
<p>In pulsed mode, the thread waits for an external wake-up signal that has to be sent by the GUI. When the wake-up signal is received, a single frame is computed. vAmiga uses this mode to implement VSYNC.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">THREAD_ADAPTIVE</span></code>:</p>
<p>In adaptive mode, the thread waits for an external wake-up signal just as it does in pulsed mode. When the wake-up signal comes in, the thread computes the number of missing frames based on the current time and the time the thread had been lauchen. Then it executes all missing frames or resynchronizes if the number of missing frames is way off. Adaptive mode has been introduced in vAmiga 2.4. It has become the new default mode since then.</p>
</li>
</ul>
</section>
<section id="state-model">
<h2>State model<a class="headerlink" href="#state-model" title="Permalink to this heading">Â¶</a></h2>
<p>Letâs take a closer look at the <code class="docutils literal notranslate"><span class="pre">isRunning()</span></code> function, whose implementation is very straightforward:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span> <span class="n">isRunning</span><span class="p">()</span> <span class="n">const</span> <span class="n">override</span> <span class="p">{</span> <span class="k">return</span> <span class="n">state</span> <span class="o">==</span> <span class="n">EXEC_RUNNING</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">state</span></code> may hold one of the following values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">EXEC_OFF</span></code>: The emulator is turned off.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXEC_PAUSED</span></code>: The emulator is turned on, but not running.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXEC_RUNNING</span></code>: The emulator does its job. The virtual Amiga is alive.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXEC_SUSPENDED</span></code>: The emulator is paused for a short period of time.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">EXEC_HALTED</span></code>: The emulator is shutting down.</p></li>
</ul>
<p>The following image provides a visual representation of the state model:</p>
<p><img alt="State model" src="../_images/stateModel.png" /></p>
<p>After creating an instance of the <code class="docutils literal notranslate"><span class="pre">Amiga</span></code> class the emulator is in <code class="docutils literal notranslate"><span class="pre">OFF</span></code> state. By calling the function <code class="docutils literal notranslate"><span class="pre">powerOn()</span></code> the emulator is put into <code class="docutils literal notranslate"><span class="pre">PAUSED</span></code> state. This is the same state that is entered when the user presses the <em>Pause</em> button in the toolbar. A call to <code class="docutils literal notranslate"><span class="pre">run()</span></code> brings the virtual Amiga to life by putting it into a <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code> state.</p>
<p>The Thread class provides a suspend-resume mechanism that can be used to pause the thread for a short period of time. This functionality is frequently used by the graphical user interface to carry out atomic operations that cannot be performed while the emulator is running. Theoretically, the thread could also be put into <code class="docutils literal notranslate"><span class="pre">PAUSED</span></code> state for this purpose, but this would also stop audio. To avoid disruptions, a special <code class="docutils literal notranslate"><span class="pre">SUSPENDED</span></code> state has been added. In this state the execute function is no longer called, but other services, such as the audio playback, are kept alive.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SUSPENDED</span></code> state is entered by calling <code class="docutils literal notranslate"><span class="pre">suspend()</span></code> and exited by calling <code class="docutils literal notranslate"><span class="pre">resume()</span></code>. Critical code sections can be executed safely by embedding them in a suspend-resume block like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">suspend</span><span class="p">();</span>

<span class="c1">// Change the internal state of the emulator as you like.</span>

<span class="n">resume</span><span class="p">();</span>
</pre></div>
</div>
<p>It is safe to nest multiple suspend-resume blocks, but it is essential that each call to <code class="docutils literal notranslate"><span class="pre">suspend()</span></code> is followed by a call to <code class="docutils literal notranslate"><span class="pre">resume()</span></code>. Consequently, the critical code section must not be exited in the middle, e.g. by throwing an exception. For this reason, you will often see the keyword <code class="docutils literal notranslate"><span class="pre">SUSPENDED</span></code> in the code, which is an exit-safe wrapper around <code class="docutils literal notranslate"><span class="pre">suspend()</span></code> and <code class="docutils literal notranslate"><span class="pre">resume()</span></code>. With this macro, the above code snippet can be rewritten as follows:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w">   </span><span class="n">SUSPENDED</span>

<span class="w">    </span><span class="c1">// Change the internal state of the emulator as you like.</span>
<span class="w">    </span><span class="c1">// Feel free to return or throw an exception.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To speed up emulation, e.g. during disk accesses, the emulator may be put into <em>warp mode</em>, which is also handled by the <code class="docutils literal notranslate"><span class="pre">Thread</span></code> class. As you have seen in the code fragment of the <code class="docutils literal notranslate"><span class="pre">Thread::main()</span></code> function, neither of the two synchronization functions is called when warp mode is active.</p>
<p>Similar to warp mode, the emulator can be put into <em>track mode</em>. This mode is activated when the GUI debugger is opened and deactivated when the debugger is closed. In track mode, several time-consuming tasks are performed that are normally skipped. For example, the CPU keeps track of all executed instructions and stores the recorded information in a trace buffer.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Thread</span></code> class provides several API functions for changing state such as <code class="docutils literal notranslate"><span class="pre">powerOn()</span></code>, <code class="docutils literal notranslate"><span class="pre">powerOff()</span></code>, <code class="docutils literal notranslate"><span class="pre">run()</span></code>, <code class="docutils literal notranslate"><span class="pre">pause()</span></code> or <code class="docutils literal notranslate"><span class="pre">halt()</span></code>. These functions request the thread to change state by setting the following variable to <code class="docutils literal notranslate"><span class="pre">true</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span><span class="w"> </span><span class="n">stateChangeRequest</span><span class="p">;</span>
</pre></div>
</div>
<p>As you may have already seen in the code snippet above, the <code class="docutils literal notranslate"><span class="pre">main</span></code> function checks this variable in each iteration of the <code class="docutils literal notranslate"><span class="pre">while</span></code> loop and performs a state change when necessary. The implementation of function <code class="docutils literal notranslate"><span class="pre">switchState</span></code> looks like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">newState</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXEC_OFF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXEC_PAUSED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="n">CoreComponent</span><span class="o">::</span><span class="n">powerOn</span><span class="p">();</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXEC_PAUSED</span><span class="p">;</span>

<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXEC_OFF</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">newState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXEC_RUNNING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="n">CoreComponent</span><span class="o">::</span><span class="n">powerOn</span><span class="p">();</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXEC_PAUSED</span><span class="p">;</span>
<span class="w">       </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">...</span>
<span class="w">        </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">EXEC_HALTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="n">CoreComponent</span><span class="o">::</span><span class="n">halt</span><span class="p">();</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXEC_HALTED</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
</section>
</section>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/icon.png" alt="Logo"/>
            </a></p>
          <div class="sidebar-resize-handle"></div>

<h3><a href="../index.html">Table of Contents</a></h3>
<p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Overview/About.html">About</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/GettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorials/Exploring.html">Exploring the User Interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../HowTo/MappingCmd.html">Mapping the Command keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowTo/NullModemCable.html">Connecting Two Amigas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../References/Preferences/index.html">Emulator Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../References/Configuration/index.html">Virtual Machine Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../References/FileFormats.html">Supported File Formats</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers Corner</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ClassHierarchy.html">The Class Hierarchy</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">The Thread Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="MessageQueue.html">The Message Queue</a></li>
<li class="toctree-l1"><a class="reference internal" href="RunLoop.html">The Run Loop</a></li>
<li class="toctree-l1"><a class="reference internal" href="EventScheduler.html">The Event Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="SuperHires.html">SuperHires mode</a></li>
</ul>

<div><hr class="docutils"></div>
<ul>
  <li class="toctree-l1"><a class="reference internal" href="../genindex.html" accesskey="I">General Index</a></li>
</ul>
<div id="ethical-ad-placement"></div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <nav class="relbar">
      <a class="previous" href="ClassHierarchy.html" aria-label="Previous topic" >
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"/></svg>
        </div>
        <div class="title">
          <span class="text">
            <span class="direction">previous</span>
            The Class Hierarchy
          </span>
        </div>
      </a>
      <a class="next" href="MessageQueue.html" aria-label="Next topic" >
        <div class="title">
          <span class="text">
            <span class="direction">next</span>
            The Message Queue
          </span>
        </div>
        <div class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"/></svg>
        </div>
      </a>
    </nav>

    <footer role="contentinfo">
      &#169; Copyright 2023, Dirk W. Hoffmann.
      Created using <a class="reference external" href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
      <a class="reference external" href="https://insipid-sphinx-theme.readthedocs.io/">Insipid Theme</a>.
<a class="reference internal" href="../_sources/Developer/ThreadClass.md.txt" rel="nofollow">Show Source</a>.
    </footer>
  </body>
</html>